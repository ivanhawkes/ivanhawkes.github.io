<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon href=/img/apple-icon.png><link rel=icon href=/img/favicon.png><title>Life Reboot</title>
<meta name=twitter:card content="summary"><meta name=twitter:title content="Adding EnTT ECS to Chrysalis"><meta name=twitter:description content="I discuss the process of adding EnTT ECS into Chrysalis."></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top"><div class=container-fluid><a class=navbar-brand href=https://ivanhawkes.github.io/>Ivan Hawkes</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class=nav-item><a href=https://ivanhawkes.github.io/post class="nav-link d-flex align-items-center"><i class=bi-stickies></i>&#160;Posts</a></li><li class=nav-item><a href=https://ivanhawkes.github.io/project class="nav-link d-flex align-items-center"><i class=bi-kanban></i>&#160;Our Projects</a></li><li class=nav-item><a href=https://ivanhawkes.github.io/profile class="nav-link d-flex align-items-center"><i class=bi-file-earmark-person></i>&#160;Our Team</a></li><li class=nav-item><a href=https://ivanhawkes.github.io/recipe class="nav-link d-flex align-items-center"><i class=bi-egg-fried></i>&#160;Recipes</a></li><li class=nav-item><a href=https://ivanhawkes.github.io/garden class="nav-link d-flex align-items-center"><i class=bi-tree></i>&#160;Garden</a></li><li class=nav-item><a href=https://ivanhawkes.github.io/about class="nav-link d-flex align-items-center"><i class=bi-person-lines-fill></i>&#160;About Us</a></li></ul></div></div></nav><div class=container><div class=container><div class=row><div class="col text-center"><h1>Adding EnTT ECS to Chrysalis</h1><div class=card><div class="card-header card-header-image"><a href=#pablo><img src=/img/site/category/programming.jpg class=card-img-top alt></a><div class=colored-shadow style=background-image:url(/img/site/category/programming.jpg);opacity:1></div></div><div class=card-body><p class=text-start></p></div></div></div></div><div class=row><div class=col-12><hr></div></div><div class=row><div class=col-6><p class=h6>By Ivan Hawkes<br>December 31, 2019</p></div><div class="col-6 text-end"><a href="https://www.facebook.com/sharer/sharer.php?u=ivan.hawkes" class=btn target=_blank><i class=bi-facebook style=font-size:32px></i>
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=ivan-hawkes-a8386338" class=btn target=_blank><i class=bi-linkedin style=font-size:32px></i></a>
<a href="http://www.pinterest.com/pin/find/?url=ivanhawkes" class=btn target=_blank><i class=bi-pinterest style=font-size:32px></i></a></div></div><div class=row><div class=col-12><hr></div></div><div class=row><div class=col><p>In this article I will discuss the process I followed and the results of integrating the <a href=https://github.com/skypjack/entt>EnTT</a> Entity Component System (ECS) into Chrysalis.</p><p>The work to date is available in my <a href=https://github.com/ivanhawkes/Chrysalis>Github repository</a> with the specific code at the time of writing being under this <a href=https://github.com/ivanhawkes/Chrysalis/commit/9d60e35e7cc1cd6af2227917c1be2fc7da75e03a>squashed commit</a>.</p><p>But first, let&rsquo;s quickly dive into the murky waters of programmer motivation and the endless sea of work and time that threatens to drown even the most enthusiastic.</p><p>If you read the commit log you can see I actually started work on this November 1, 2019. That seems a long time ago as I sit here, on New Year&rsquo;s Eve. So what happened?</p><p>I&rsquo;ve been working on this for almost seven years. It&rsquo;s slow progress because I am having to learn vast amounts of new things, and much of it isn&rsquo;t from handy YouTube videos, but rather from reading blocks of decade old code. That&rsquo;s enough to sap even the mightiest of spirits over the long term. I take lengthy breaks along the way to give my mind a rest from thinking about something that seems so far off.</p><p>Being able to show off the results of the work is always rewarding, and although - to the untrained eye, there is almost nothing happening, the code is all working away in the background.</p><p>Thanks to GDC, YouTube, and programmer blogs I have learnt about the very interesting idea of an ECS. I leant c++ sometime in the early 90&rsquo;s and they really hammered home the object oriented paradigm so much that I grew sick of the word paradigm. That&rsquo;s why my ears pricked up when hearing there was a good solution to some of the common problems found in RPG games. By eschewing OOP I could free myself from it&rsquo;s tentacles and the dreaded and frequently stupid inheritance it forced upon me. Better still, I could improve memory layout and cache coherence - which would be a factor if I ever make it far enough to launch a multi-player version of the toolkit.</p><p>ECS works by getting you to decompose your data down to orthogonal components and then re-compose them into entities. You write systems that iterate over the entities and then execute the data they contain in a data driven approach. For me, it&rsquo;s similar to working out a data schema for a database, getting it to third normal form, and then cutting the tables up even more until they are just independent concepts. I&rsquo;ll offer an example a little further down.</p><p>Using an ECS means short term effort and time which should pay itself back many times over the long term. I decided on using EnTT based on the simple and hopefully effective metric of the most stars on Github. It&rsquo;s already proven itself a good decision as the API is well designed, the code is fast and lean, and the main developer is very helpful.</p><p>Having made the decision to try and integrate the ECS into my code, it was just a matter of knuckling down and getting the job done. At least, that&rsquo;s what you would think, it was actually a little more challenging than adding a new SDK and a line to my cmake file.</p><p>EnTT uses the latest compilers and won&rsquo;t build without c++17. By contrast, CRYENGINE has a 15 year history, a lot of kruft, and is happier with older compilers. In fact, some parts (very few to be fair) simply wouldn&rsquo;t build with the newest compilers. This hit both myself and another developer at various points as the ever keen to update MSVC convinced me to update to new compilers. I shouldn&rsquo;t have done it, because I once again found myself deleting both MSVC 2017 and 2019 and re-installing from scratch. I lost a couple of days from messing with my development environment, something I should be old enough to resist doing.</p><p>With the environment back in action, and the sizeable and complex CRYENGINE code all building once more, I jumped back into investigating EnTT. It looked good, but only a tracer bullet would show if it was suitable for my tasks.</p><p>EnTT does some things with c++ that I have honestly never encountered before. That&rsquo;s a good thing. I like to stretch and grow, but first - the growing pains. It&rsquo;s very heavily templated, and the first blockade I hit was mostly motivational and template driven.</p><p>Looking at the test code, it wasn&rsquo;t hard to slap together a very simple test that ensured EnTT code was running with my code. That was confirmed pretty quickly. What I was really worried about was serialising the data to and from some files. For some reason I can&rsquo;t comprehend why three things in c++ just plain suck.</p><ul><li>strings, wide strings, localised strings</li><li>serialisation of plain old data structures</li><li>reflection</li></ul><p>The last two are related. The strings one seems to be because everyone thinks they can write a better string class. Then you need to convert the string classes of one library to the string classes of another. I don&rsquo;t even want to talk about wide strings and localisation.</p><p>What I wanted before I doubled down on the library was to make sure I could serialise to and from files - preferably TOML, JSON if that failed, and worst case - XML. Spoiler alert, I ended up with XML. Finding out my options - and then just relenting and using XML burnt up a lot of real world time and mind space. Now, part of this was because the documentation was a little weak around the subject of snapshots. Part was the way getting one little thing wrong would spew out 20 long indecipherable template errors. Part was the CRYENGINE code having two / three different but somewhat entangled serialisation sections. Part was me just hating XML and not leaning in like I should have - since the CRYENGINE library had decent enough support for it. The final part was an actual bug in the EnTT library which the developer not only helped me diagnose, but then quickly fixed and pushed a release. This had taken a lot of real world time, though in reality it wasn&rsquo;t more than a couple of days of actual work.</p><p>By December 20th I had the library integrated and sufficiently exercised for me to feel confident in it&rsquo;s use. I had a few test components which I could create in memory, write to files, and read back. It was time to double down! This is where we really hit the turbo.</p><p>It&rsquo;s hard to think of an RPG without thinking about a character who battles non-player characters. They cast spells using their qi (chi / mana), and take hits from enemies as damage to their health. If I wanted to make the core of an RPG I could do far worse than try and create a set of components and systems that allow me to simulate an entity with health, qi, and a list of spells. This turns out to be surprisingly easy, if a little verbose, when you have an ECS.</p><p>I start out by defining an attribute. Health, qi, wisdom, strength, spell power - they are all just attributes - so I try and kick off with that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> TYPE<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>AttributeType</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	AttributeType() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>AttributeType() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	AttributeType(TYPE base, TYPE baseModifiers, TYPE modifiers) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		base(base), baseModifiers(baseModifiers), modifiers(modifiers)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>Serialize</span>(Serialization<span style=color:#f92672>::</span>IArchive<span style=color:#f92672>&amp;</span> archive)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		archive(base, <span style=color:#e6db74>&#34;base&#34;</span>, <span style=color:#e6db74>&#34;base&#34;</span>);
</span></span><span style=display:flex><span>		archive(baseModifiers, <span style=color:#e6db74>&#34;baseModifiers&#34;</span>, <span style=color:#e6db74>&#34;baseModifiers&#34;</span>);
</span></span><span style=display:flex><span>		archive(modifiers, <span style=color:#e6db74>&#34;modifiers&#34;</span>, <span style=color:#e6db74>&#34;modifiers&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Returns the current value for base, after it&#39;s modifiers have been applied. */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> TYPE <span style=color:#a6e22e>GetBaseAttribute</span>() <span style=color:#66d9ef>const</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> base <span style=color:#f92672>+</span> baseModifiers;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Returns the current value for the attribute, after it&#39;s modifiers have been applied. */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> TYPE <span style=color:#a6e22e>GetAttribute</span>() <span style=color:#66d9ef>const</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> base <span style=color:#f92672>+</span> modifiers;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Represents the attribute without any modifiers applied to it. */</span>
</span></span><span style=display:flex><span>	TYPE base;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** This modifier makes changes to the base value, instead of the frame value. Typical use would be for a health / strength 
</span></span></span><span style=display:flex><span><span style=color:#75715e>	buff that increases the base value of the attribute. */</span>
</span></span><span style=display:flex><span>	TYPE baseModifiers;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Modifiers for this frame. Should be calculated each frame prior to calculating the current value. */</span>
</span></span><span style=display:flex><span>	TYPE modifiers;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>It feels a little loose, but at this stage I am willing to trust it will be used correctly. Writing setters and getters is busy work, and I&rsquo;d rather keep the code open for the moment. The main thing wrong here is it&rsquo;s a template but I didn&rsquo;t restrict it to types that have plus operators, so it will fail if you use strings as the TYPE. I should really learn how to write an error condition for that. my template-fu is still pretty weak.</p><p>With that sorted, what&rsquo;s the one thing that entities almost all have? A name. It&rsquo;s tempting to add it to some other component, but let&rsquo;s try and keep this pure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Name</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IComponent
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	Name() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>Name() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	Name(string name, string displayName) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		name(name), displayName(displayName)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>==</span>(<span style=color:#66d9ef>const</span> Name<span style=color:#f92672>&amp;</span> rhs) <span style=color:#66d9ef>const</span> { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>==</span> memcmp(<span style=color:#66d9ef>this</span>, <span style=color:#f92672>&amp;</span>rhs, <span style=color:#66d9ef>sizeof</span>(rhs)); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> CryGUID<span style=color:#f92672>&amp;</span> GetGuid() <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>final</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>static</span> CryGUID guid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;{8BEB64DA-F589-4671-96E9-D136A5E5DED7}&#34;</span>_cry_guid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> guid;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>const</span> entt<span style=color:#f92672>::</span>hashed_string<span style=color:#f92672>&amp;</span> GetHashedName() <span style=color:#66d9ef>const</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>constexpr</span> entt<span style=color:#f92672>::</span>hashed_string nameHS {<span style=color:#e6db74>&#34;name&#34;</span>_hs};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> nameHS;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ReflectType</span>(Schematyc<span style=color:#f92672>::</span>CTypeDesc<span style=color:#f92672>&lt;</span>Name<span style=color:#f92672>&gt;&amp;</span> desc)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		desc.SetGUID(Name().GetGuid());
</span></span><span style=display:flex><span>		desc.SetLabel(<span style=color:#e6db74>&#34;Name&#34;</span>);
</span></span><span style=display:flex><span>		desc.SetDescription(<span style=color:#e6db74>&#34;Name&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>Serialize</span>(Serialization<span style=color:#f92672>::</span>IArchive<span style=color:#f92672>&amp;</span> archive) <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>final</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		archive(name, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>);
</span></span><span style=display:flex><span>		archive(displayName, <span style=color:#e6db74>&#34;displayName&#34;</span>, <span style=color:#e6db74>&#34;displayName&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** A unique name for this particular item class. */</span>
</span></span><span style=display:flex><span>	string name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** A name which can be used in the UI. */</span>
</span></span><span style=display:flex><span>	string displayName;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Whew, there&rsquo;s a lot of boiler-plate code just to get a couple of simple fields of data. That&rsquo;s not a requirement of EnTT, but rather CRYENGINE. I decided to make life for future me better by ensuring both serialisation paths can be supported. One is for general use, the other for components that are used in Schematyc / editor. It&rsquo;s probably overkill, but worth the pain, for now. EnTT actually has snapshots, and if I had persevered and gotten the snapshot loader to work I could skip all this. Future me can do that. I&rsquo;ll skip the boiler-plate for subsequent code.</p><p>Now we are getting to the good part. Adding a health component and a damage component give us the start of a health system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Health</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IComponent
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	Health() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>Health() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	Health(AttributeType<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float</span><span style=color:#f92672>&gt;</span> health) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		health(health)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Health attribute. */</span>
</span></span><span style=display:flex><span>	AttributeType<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float</span><span style=color:#f92672>&gt;</span> health;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Is the actor dead? */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>bool</span> isDead {false};
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Damage</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IComponent
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	Damage() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>Damage() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	Damage(<span style=color:#66d9ef>float</span> quantity, DamageType damageType) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		quantity(quantity), damageType(damageType)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** Modify an attribute by this amount. */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float</span> quantity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** The type of damage. */</span>
</span></span><span style=display:flex><span>	DamageType damageType;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>There&rsquo;s actually one more component which is needed now. Damage is no good if we don&rsquo;t know who caused it to whom. Let&rsquo;s add a component that is general enough to work for not just damage, but other special cases too.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SourceAndTarget</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> IComponent
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	SourceAndTarget() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>SourceAndTarget() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	SourceAndTarget(entt<span style=color:#f92672>::</span>entity sourceEntity, entt<span style=color:#f92672>::</span>entity targetEntity) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		sourceEntity(sourceEntity), targetEntity(targetEntity)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** The source of the heal. */</span>
</span></span><span style=display:flex><span>	entt<span style=color:#f92672>::</span>entity sourceEntity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** The target that will receive the heal - require a Health component. */</span>
</span></span><span style=display:flex><span>	entt<span style=color:#f92672>::</span>entity targetEntity;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Now we just need a system that executes these components and applies their changes. It&rsquo;s simple enough. I&rsquo;m actually only going to show this one system, because the others are pretty similar. They apply damage over time, heals, and qi management instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SystemApplyDamage</span>(entt<span style=color:#f92672>::</span>registry<span style=color:#f92672>&amp;</span> registry)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Apply any damage to the damage modifiers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>auto</span> view <span style=color:#f92672>=</span> registry.view<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Damage, ECS<span style=color:#f92672>::</span>SourceAndTarget<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> entity : view)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Get the components.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> damage <span style=color:#f92672>=</span> view.get<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Damage<span style=color:#f92672>&gt;</span>(entity);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> sourceAndTarget <span style=color:#f92672>=</span> view.get<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>SourceAndTarget<span style=color:#f92672>&gt;</span>(entity);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> targetHealth <span style=color:#f92672>=</span> registry.get<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Health<span style=color:#f92672>&gt;</span>(sourceAndTarget.targetEntity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Get the health component for the target entity and apply the damage to it&#39;s health modifier.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		targetHealth.health.modifiers <span style=color:#f92672>-=</span> damage.quantity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Remove just the component.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		registry.remove<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Damage<span style=color:#f92672>&gt;</span>(entity);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It takes a fair amount of groundwork to set up, but very little actual code to execute each update. Here you can see a view (query) of the registry (place where all the entities are stored). It only considers entities with both a ECS::Damage and a ECS::SourceAndTarget. Using that data, it looks up the target entity, finds it&rsquo;s health component and applies the changes required.</p><p>When all the damage and heals have been applied to the attributes and their modifiers we run through once more and mark the dead. At some point I will have to take some action, but not today, Death, not today.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SystemHealthCheck</span>(entt<span style=color:#f92672>::</span>registry<span style=color:#f92672>&amp;</span> registry)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Update each health component, applying the modifier to it&#39;s base to calculate the current health.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Update death status if appropriate.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>auto</span> view <span style=color:#f92672>=</span> registry.view<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Health, ECS<span style=color:#f92672>::</span>SourceAndTarget<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> entity : view)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Get the components..
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> health <span style=color:#f92672>=</span> view.get<span style=color:#f92672>&lt;</span>ECS<span style=color:#f92672>::</span>Health<span style=color:#f92672>&gt;</span>(entity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Check for overkill.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>float</span> newHealth <span style=color:#f92672>=</span> health.health.GetBaseAttribute() <span style=color:#f92672>+</span> health.health.modifiers;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (newHealth <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0.0f</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			health.isDead <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// TODO: Inform them they died with -newHealth being the amount of overkill.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And now, we finally get to the fun part - creating some spells. We&rsquo;ll start with something really bare bones, and expand it from there. Just a spell name and a range will do - oh wait, we have a name component already, so our spell only has range right now - and even that isn&rsquo;t being used.</p><p>EnTT let&rsquo;s you use as many registries as you want, and includes the ability to clone entities from one into another. This allows me to prototype the spells using XML and the components, clone it across to the actor registry, and then apply the damage / qi changes to the actors involved. I started with a couple of the really obvious spells.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;entities&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;entity&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;components&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;name</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Fireball&#34;</span> <span style=color:#a6e22e>displayName=</span><span style=color:#e6db74>&#34;Fireball&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;spell</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>spell-rewire=</span><span style=color:#e6db74>&#34;damage&#34;</span> <span style=color:#a6e22e>range=</span><span style=color:#e6db74>&#34;30&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;damage</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;14&#34;</span> <span style=color:#a6e22e>damageType=</span><span style=color:#e6db74>&#34;fire&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;utilise-qi</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;7&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/components&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;/entity&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;entity&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;components&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;name</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Shadow Word Pain&#34;</span> <span style=color:#a6e22e>displayName=</span><span style=color:#e6db74>&#34;Shadow Word Pain&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;spell</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>spell-rewire=</span><span style=color:#e6db74>&#34;damage&#34;</span> <span style=color:#a6e22e>range=</span><span style=color:#e6db74>&#34;25&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;damage-over-time</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>damageType=</span><span style=color:#e6db74>&#34;unholy&#34;</span> <span style=color:#a6e22e>duration=</span><span style=color:#e6db74>&#34;10&#34;</span> <span style=color:#a6e22e>interval=</span><span style=color:#e6db74>&#34;1.5&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;utilise-qi</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;6&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/components&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;/entity&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;entity&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;components&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;name</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Heal&#34;</span> <span style=color:#a6e22e>displayName=</span><span style=color:#e6db74>&#34;Heal&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;spell</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>spell-rewire=</span><span style=color:#e6db74>&#34;heal&#34;</span> <span style=color:#a6e22e>range=</span><span style=color:#e6db74>&#34;25&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;heal</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;17&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;utilise-qi</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;8&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/components&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;/entity&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;entity&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;components&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;name</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Renew&#34;</span> <span style=color:#a6e22e>displayName=</span><span style=color:#e6db74>&#34;Renew&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;spell</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>spell-rewire=</span><span style=color:#e6db74>&#34;heal&#34;</span> <span style=color:#a6e22e>range=</span><span style=color:#e6db74>&#34;25&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;heal-over-time</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;3&#34;</span> <span style=color:#a6e22e>duration=</span><span style=color:#e6db74>&#34;10&#34;</span> <span style=color:#a6e22e>interval=</span><span style=color:#e6db74>&#34;2&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;utilise-qi</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;8&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/components&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;/entity&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;entity&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;components&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;name</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Innervate&#34;</span> <span style=color:#a6e22e>displayName=</span><span style=color:#e6db74>&#34;Innervate&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;spell</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>spell-rewire=</span><span style=color:#e6db74>&#34;regenerate&#34;</span> <span style=color:#a6e22e>range=</span><span style=color:#e6db74>&#34;25&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;replenish-qi-over-time</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;4&#34;</span> <span style=color:#a6e22e>duration=</span><span style=color:#e6db74>&#34;10&#34;</span> <span style=color:#a6e22e>interval=</span><span style=color:#e6db74>&#34;2&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;utilise-qi</span> <span style=color:#a6e22e>CryXmlVersion=</span><span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>quantity=</span><span style=color:#e6db74>&#34;20&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/components&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;/entity&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/entities&gt;</span>
</span></span></code></pre></div><p>With all this in place I can finally fire up the editor and witness the glory of&mldr;some debug text changing values. I haven&rsquo;t added any of the important parts yet. Range doesn&rsquo;t work, and spells care not if they land on friend or foe. Health and qi allow you as large a mortgage as you please, and death never comes to visit.</p><p>What we do have now however is fairly significant.</p><p>I can connect to a character in the world, make them walk, jog, crouch and run. Switch between first and third person cameras. Target another actor by looking at them, and trigger a range of spells whose effects are all data driven. Soon enough that will be replete with special effects, animations, cooldowns and all the other accoutrements. For now, it&rsquo;s enough, and a good end to the old year with a positive start to the new year.</p><p>For years now it&rsquo;s felt like walking through molasses, but now, things are changing at a rapid pace and the future looks bright.</p></div></div><div class=row><div class=col-12><hr></div></div><div class=row><div class=col><p class=h6>Discover more posts like this:</p><p class=h6><a class="btn btn-primary" href=/tags/c++>C++
</a><a class="btn btn-primary" href=/tags/chrysalis>Chrysalis
</a><a class="btn btn-primary" href=/tags/cryengine-5.6>CRYENGINE 5.6
</a><a class="btn btn-primary" href=/tags/game-programming>Game Programming</a></p></div></div><div class=row><div class=col><hr></div></div><div class=row><div class="col-6 text-start">Previous:<br><a href=https://ivanhawkes.github.io/post/switching-to-cryengine-5-3-new-entity-system/>Switching to CRYENGINE 5.3 New Entity System</a></div><div class="col-6 text-end">Next:<br><a href=https://ivanhawkes.github.io/post/chrysalis-update-2020-08-02/>Chrysalis Update for 2020-08-02</a></div></div></div></div><footer><div class=row><div class=col><hr></div></div><nav class="navbar navbar-expand-lg"><div class=container-fluid>&copy; 2021 Ivan Hawkes all rights reserved.</div></nav></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js integrity=sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css integrity=sha384-7ynz3n3tAGNUYFZD3cWe5PDcE36xj85vyFkawcF6tIwxvIecqKvfwLiaFdizhPpN crossorigin=anonymous><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons"></body></html>