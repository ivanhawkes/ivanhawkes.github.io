<!doctype html><html>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=apple-touch-icon href=/img/apple-icon.png>
<link rel=icon href=/img/favicon.png>
<title>Life Reboot</title>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="CryEngine 3 System Event Dispatcher">
<meta name=twitter:description content="Earlier this week I wrote about CryEngine listener classes in a brief overview. I intimated that they are an excellent way to write code against the CryEngine SDK and today I want to go into more depth.">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
<div class=container-fluid>
<a class=navbar-brand href=https://www.hawkes.info/>Ivan Hawkes</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class=nav-item>
<a href=https://www.hawkes.info/post class="nav-link d-flex align-items-center">
<i class=bi-stickies></i>&#160;Posts
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/project class="nav-link d-flex align-items-center">
<i class=bi-kanban></i>&#160;Our Projects
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/profile class="nav-link d-flex align-items-center">
<i class=bi-file-earmark-person></i>&#160;Our Team
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/recipe class="nav-link d-flex align-items-center">
<i class=bi-egg-fried></i>&#160;Recipes
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/garden class="nav-link d-flex align-items-center">
<i class=bi-tree></i>&#160;Garden
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/plant class="nav-link d-flex align-items-center">
<i class=bi-flower1></i>&#160;Plants
</a>
</li>
<li class=nav-item>
<a href=https://www.hawkes.info/about class="nav-link d-flex align-items-center">
<i class=bi-person-lines-fill></i>&#160;About Us
</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=container>
<div class=container>
<div class=row>
<div class="col text-center">
<h1>CryEngine 3 System Event Dispatcher</h1>
<div class=card>
<div class="card-header card-header-image">
<a href=#pablo>
<img src=/img/site/category/cryengine.jpg class=card-img-top alt>
</a>
<div class=colored-shadow style=background-image:url(/img/site/category/cryengine.jpg);opacity:1></div>
</div>
<div class=card-body>
<p class=text-start></p>
</div>
</div>
</div>
</div>
<div class=row>
<div class=col-12>
<hr>
</div>
</div>
<div class=row>
<div class=col-6>
<p class=h6>
By Ivan Hawkes<br>March 15, 2014
</p>
</div>
<div class="col-6 text-end">
<a href="https://www.facebook.com/sharer/sharer.php?u=ivan.hawkes" class=btn target=_blank>
<i class=bi-facebook style=font-size:32px></i>
</a>
<a href="https://twitter.com/intent/tweet?url=%40ivanhawkes" class=btn target=_blank>
<i class=bi-twitter style=font-size:32px></i>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=ivan-hawkes-a8386338" class=btn target=_blank>
<i class=bi-linkedin style=font-size:32px></i></a>
<a href="http://www.pinterest.com/pin/find/?url=ivanhawkes" class=btn target=_blank>
<i class=bi-pinterest style=font-size:32px></i></a>
</div>
</div>
<div class=row>
<div class=col-12>
<hr>
</div>
</div>
<div class=row>
<div class=col>
<p>Earlier this week I wrote about CryEngine listener classes in a brief overview. I intimated that they are an excellent way to write code against the CryEngine SDK and today I want to go into more depth.</p>
<p>I briefly covered the 40 odd listeners that I was able to locate in my article <a href=http://ivan.hawkes.info/2014/03/07/introducing-cryengine-3-event-listeners/ title="Introducing CryEngine 3 Event Listeners">Introducing CryEngine 3 Event Listeners</a>. Today I would like to revisit just one of those listeners, <strong>ISystemEventListener</strong>.</p>
<h2 id=the-plugin-sdk>The Plugin SDK</h2>
<p>But first, a little background. I&rsquo;m a big fan of the <a href=https://github.com/hendrikp/Plugin_SDK title="Plugin SDK">Plugin SDK</a>. Being able to write code that just slips into place without requiring changes to the existing codebase is&mldr;well, awesome. CryEngine SDK is a moving target, and the less changes I need to make to the existing codebase, the easier my job will be in the future. Plugin SDK does an excellent job at making that happen, though it&rsquo;s up to you as to how well it happens.</p>
<p>My first attempts to make a camera work with the Plugin SDK were&mldr;let&rsquo;s say not good. I felt constricted by it&rsquo;s initialisation routines and much of my code ended up entangled inside the template Plugin SDK code. It took a little re-factoring, and a little more knowledge of the internals of CryEngine SDK, but I finally made my peace with Plugin SDK.</p>
<p>Before we get started, let me just mention the motivation that pushed me this way. Just recently CryTek announced that they will for the first time support a fully functional version of the CryEngine on Linux. Unfortunately, Linux does not support Windows DLLs and so nothing I write using the Plugin SDK will be available for a Linux version of my client. That&rsquo;s clearly unacceptable, so I went about finding a way to have my cake and eat it too.</p>
<p>My initial code written using the Plugin SDK had a few needs:</p>
<ul>
<li>an initialisation routine</li>
<li>a shutdown routine</li>
<li>and due to my own stupidity, some globals were defined here</li>
</ul>
<p>The Plugin SDK kindly provides a callback to start any initialisation you require, but for my needs it was being called a little too soon in the start-up process. I had added some calls to filter the input maps, but those were not available at the time my init routine was being called. Initially I moved the Plugin SDK initialisation routines further down inside the CryEngine Game SDK code, but as I dug a little deeper I found a way to do it without resorting to such means.</p>
<h2 id=isystemeventlistener>ISystemEventListener</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>ISystemEventListener</span>
{
	<span style=color:#75715e>// 
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>ISystemEventListener(){}
	<span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>OnSystemEventAnyThread</span>( ESystemEvent event,UINT_PTR wparam,UINT_PTR lparam ) {}
	<span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>OnSystemEvent</span>( ESystemEvent event,UINT_PTR wparam,UINT_PTR lparam ) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
	<span style=color:#75715e>// 
</span><span style=color:#75715e></span>};
</code></pre></div><p>It doesn&rsquo;t appear to be very much from the definition, but don&rsquo;t be fooled, this is truly an intrinsic part of the CryEngine.</p>
<p>You can disregard pretty much everything except for the <strong>OnSystemEvent</strong> function which will be called within a listener at key points in program execution.</p>
<p>The <strong>OnSystemEvent</strong> works a little bit like the Windows event handler; it even has similar parameters. What&rsquo;s most important about this observer however is the messages it passes down to it&rsquo;s listeners. Each call on this function passes an <strong>ESystemEvent</strong> to the receiving function. If you hook onto this observer, you can receive a large number of incredibly useful events. This includes things like level loading, game-play start / init and finish, pausing, and system shutdown. I&rsquo;m just going to cover <strong>ESYSTEM_EVENT_GAME_POST_INIT</strong> and <strong>ESYSTEM_EVENT_SHUTDOWN</strong> since for me these are the most important.</p>
<p>Now, as I mentioned, the Plugin SDK calls my init too soon and worse still will not be available on Linux. Both of these are solved by <strong>ESYSTEM_EVENT_GAME_POST_INIT</strong>. In order to use it I need to register a listener on the ISystem interface. It&rsquo;s not too hard, all you need to do is the following inside an init routine:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>void</span> CThirdPersonView<span style=color:#f92672>::</span>Init()
{
	CRY_ASSERT (gEnv);
	CRY_ASSERT (gEnv<span style=color:#f92672>-&gt;</span>pGame);
	CRY_ASSERT (gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework());
	CRY_ASSERT (gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework()<span style=color:#f92672>-&gt;</span>GetISystem());
	
	<span style=color:#75715e>// Register Game Objects
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (gEnv <span style=color:#f92672>&amp;&amp;</span> gEnv<span style=color:#f92672>-&gt;</span>pGame <span style=color:#f92672>&amp;&amp;</span> gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework())
	{
		<span style=color:#75715e>// Listen for system events.
</span><span style=color:#75715e></span>		gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework()<span style=color:#f92672>-&gt;</span>GetISystem()<span style=color:#f92672>-&gt;</span>GetISystemEventDispatcher()<span style=color:#f92672>-&gt;</span>RegisterListener (<span style=color:#66d9ef>this</span>);

		<span style=color:#75715e>// Listen for game events.
</span><span style=color:#75715e></span>		gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework()<span style=color:#f92672>-&gt;</span>RegisterListener (<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#34;ThirdPersonCamera&#34;</span>, FRAMEWORKLISTENERPRIORITY_DEFAULT);
	}
}
</code></pre></div><p>That&rsquo;s a lot of code for basically two lines. The one we&rsquo;re interested in is:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>gEnv<span style=color:#f92672>-&gt;</span>pGame<span style=color:#f92672>-&gt;</span>GetIGameFramework()<span style=color:#f92672>-&gt;</span>GetISystem()<span style=color:#f92672>-&gt;</span>GetISystemEventDispatcher()<span style=color:#f92672>-&gt;</span>RegisterListener (<span style=color:#66d9ef>this</span>);
</code></pre></div><p>which attaches the <strong>this</strong> pointer as a listener for <strong>ISystemEventListener</strong>. From here we just need to implement the <strong>OnSystemEvent</strong> function and we can eavesdrop on all the cool things happening inside CryEngine.</p>
<p>For this example I&rsquo;ll use the third person camera code I am working on.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>void</span> CThirdPersonView<span style=color:#f92672>::</span>OnSystemEvent(ESystemEvent event, UINT_PTR wparam, UINT_PTR lparam)
{
    <span style=color:#66d9ef>switch</span> (event)
    {
    <span style=color:#66d9ef>case</span> ESYSTEM_EVENT_GAME_POST_INIT:
    {
        RegisterCvars();
        RegisterActionMaps();
    }
    <span style=color:#66d9ef>break</span>;

    <span style=color:#66d9ef>case</span> ESYSTEM_EVENT_SHUTDOWN:
    {
        Shutdown();
    }

    <span style=color:#66d9ef>break</span>;
    }
}
</code></pre></div><p>Here you can see we&rsquo;re receiving game events and responding to a pair of them. In this case, an init event and a shut-down event. It is this pair of events that frees us from the Plugin SDK. They replace the equivalent structures provided within the Plugin SDK, but do so in a platform independent manner. Better yet, the init is called at a time when all of the SDK features are ready.</p>
<p>As long as I am able to call the init routine provided above I can ensure both initialisation and destruction for any code I wish to add to the game SDK. I can&rsquo;t stress how important it will be to decouple your code from the base code that ships with the CryEngine SDK.</p>
<p>This example registers a few CVARS, sets up some action maps and filters for those maps, and provides for clean-up when shutting down. Nothing too exciting, but it is the backbone of any extension. You can easily grab other events from there or register further listeners as needed. I haven&rsquo;t shown any of that code because it is trivial.</p>
<p>Have a look at the new re-factored <a href=https://github.com/ivanhawkes/Plugin_Camera title="Third Person Camera">Third Person Camera</a> code to see the how this can help your projects. The main body of the code is now (almost) completely decoupled from both the Plugin SDK and the stock Game SDK.</p>
<h2 id=summary>Summary</h2>
<p>Registering a listener for <strong>ISystemEventListener</strong> can give you deep access to CryEngine while allowing you to stay decoupled.</p>
</div>
</div>
<div class=row>
<div class=col-12>
<hr>
</div>
</div>
<div class=row>
<div class=col>
<p class=h6>
Discover more posts like this:
</p>
<p class=h6>
<a class="btn btn-primary" href=/tags/cryengine-3>
CryEngine 3
</a>
<a class="btn btn-primary" href=/tags/cryengine3>
CryEngine3
</a>
<a class="btn btn-primary" href=/tags/dispatcher>
Dispatcher
</a>
<a class="btn btn-primary" href=/tags/event>
event
</a>
<a class="btn btn-primary" href=/tags/listener>
listener
</a>
<a class="btn btn-primary" href=/tags/software-development>
Software Development
</a>
</p>
</div>
</div>
<div class=row>
<div class=col>
<hr>
</div>
</div>
<div class=row>
<div class="col-6 text-start">
Previous:<br><a href=https://www.hawkes.info/post/introducing-cryengine-3-event-listeners/> Introducing CryEngine 3 Event Listeners</a>
</div>
<div class="col-6 text-end">
Next:<br><a href=https://www.hawkes.info/post/wd-mybook-live-vs-raspberry-pi-as-a-linux-server/> WD MyBook Live vs Raspberry Pi as a Linux Server</a>
</div>
</div>
</div>
</div>
<footer>
<div class=row>
<div class=col>
<hr>
</div>
</div>
<nav class="navbar navbar-expand-lg">
<div class=container-fluid>
&copy; 2021 Ivan Hawkes all rights reserved.
</div>
</nav>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js integrity=sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css integrity=sha384-7ynz3n3tAGNUYFZD3cWe5PDcE36xj85vyFkawcF6tIwxvIecqKvfwLiaFdizhPpN crossorigin=anonymous>
<link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons">
</body>
</html>